[
  {
    "id": "metric:total_revenue_usd",
    "name": "Total Revenue (USD)",
    "description": "Total revenue in USD from all orders.",
    "category": "revenue",
    "grain": "global",
    "formula_natural": "Sum of the price_usd column from the orders table.",
    "formula_sql": "SELECT SUM(price_usd) AS total_revenue_usd FROM orders;",
    "tables": [
      "orders"
    ],
    "columns": [
      "price_usd"
    ]
  },
  {
    "id": "metric:total_cogs_usd",
    "name": "Total COGS (USD)",
    "description": "Total cost of goods sold in USD from all orders.",
    "category": "cost",
    "grain": "global",
    "formula_natural": "Sum of the cogs_usd column from the orders table.",
    "formula_sql": "SELECT SUM(cogs_usd) AS total_cogs_usd FROM orders;",
    "tables": [
      "orders"
    ],
    "columns": [
      "cogs_usd"
    ]
  },
  {
    "id": "metric:gross_profit_usd",
    "name": "Gross Profit (USD)",
    "description": "Revenue minus cost of goods sold, expressed in USD.",
    "category": "revenue",
    "grain": "global",
    "formula_natural": "Sum of price_usd minus sum of cogs_usd from the orders table.",
    "formula_sql": "SELECT SUM(o.price_usd) - SUM(o.cogs_usd) AS gross_profit_usd FROM orders o;",
    "tables": [
      "orders"
    ],
    "columns": [
      "price_usd",
      "cogs_usd"
    ]
  },
  {
    "id": "metric:total_refunds_usd",
    "name": "Total Refunds (USD)",
    "description": "Total amount refunded to customers in USD.",
    "category": "cost",
    "grain": "global",
    "formula_natural": "Sum of refund_amount_usd from the refunds table.",
    "formula_sql": "SELECT SUM(refund_amount_usd) AS total_refunds_usd FROM refunds;",
    "tables": [
      "refunds"
    ],
    "columns": [
      "refund_amount_usd"
    ]
  },
  {
    "id": "metric:net_revenue_usd",
    "name": "Net Revenue (USD)",
    "description": "Revenue after subtracting refunds, expressed in USD.",
    "category": "revenue",
    "grain": "global",
    "formula_natural": "Total order price_usd minus total refund_amount_usd.",
    "formula_sql": "SELECT SUM(o.price_usd) - COALESCE(SUM(r.refund_amount_usd),0) AS net_revenue_usd FROM orders o LEFT JOIN refunds r ON o.order_id = r.order_id;",
    "tables": [
      "orders",
      "refunds"
    ],
    "columns": [
      "price_usd",
      "refund_amount_usd"
    ]
  },
  {
    "id": "metric:average_order_value_usd",
    "name": "Average Order Value (USD)",
    "description": "Average revenue per order in USD.",
    "category": "revenue",
    "grain": "global",
    "formula_natural": "Average of the price_usd column from the orders table.",
    "formula_sql": "SELECT AVG(price_usd) AS average_order_value_usd FROM orders;",
    "tables": [
      "orders"
    ],
    "columns": [
      "price_usd"
    ]
  },
  {
    "id": "metric:orders_per_user",
    "name": "Orders per User",
    "description": "Average number of orders placed by each distinct user.",
    "category": "users",
    "grain": "global",
    "formula_natural": "Total number of orders divided by the count of distinct user_id in orders.",
    "formula_sql": "SELECT CAST(COUNT(*) AS float) / NULLIF(COUNT(DISTINCT user_id),0) AS orders_per_user FROM orders;",
    "tables": [
      "orders"
    ],
    "columns": [
      "order_id",
      "user_id"
    ]
  },
  {
    "id": "metric:repeat_session_rate",
    "name": "Repeat Session Rate",
    "description": "Proportion of sessions that are marked as repeat sessions.",
    "category": "users",
    "grain": "global",
    "formula_natural": "Number of sessions with is_repeat_session = 1 divided by total sessions.",
    "formula_sql": "SELECT CAST(SUM(CASE WHEN is_repeat_session = 1 THEN 1 ELSE 0 END) AS float) / NULLIF(COUNT(*),0) AS repeat_session_rate FROM sessions;",
    "tables": [
      "sessions"
    ],
    "columns": [
      "is_repeat_session"
    ]
  },
  {
    "id": "metric:pageviews_per_session",
    "name": "Pageviews per Session",
    "description": "Average number of pageviews recorded for each session.",
    "category": "engagement",
    "grain": "global",
    "formula_natural": "Total pageview records divided by distinct session count in pageviews.",
    "formula_sql": "SELECT CAST(COUNT(p.pageview_id) AS float) / NULLIF(COUNT(DISTINCT p.session_id),0) AS pageviews_per_session FROM pageviews p;",
    "tables": [
      "pageviews"
    ],
    "columns": [
      "pageview_id",
      "session_id"
    ]
  },
  {
    "id": "metric:primary_item_revenue_usd",
    "name": "Primary Item Revenue (USD)",
    "description": "Revenue generated by items flagged as primary in order_items.",
    "category": "revenue",
    "grain": "global",
    "formula_natural": "Sum of price_usd from order_items where is_primary_item equals 1.",
    "formula_sql": "SELECT SUM(price_usd) AS primary_item_revenue_usd FROM order_items WHERE is_primary_item = 1;",
    "tables": [
      "order_items"
    ],
    "columns": [
      "price_usd",
      "is_primary_item"
    ]
  },
  {
    "id": "metric:revenue_by_product_usd",
    "name": "Revenue by Product (USD)",
    "description": "Total revenue per product calculated from order_items.",
    "category": "revenue",
    "grain": "product",
    "formula_natural": "Sum of price_usd for each product_id in order_items.",
    "formula_sql": "SELECT product_id, SUM(price_usd) AS revenue_usd FROM order_items GROUP BY product_id;",
    "tables": [
      "order_items"
    ],
    "columns": [
      "product_id",
      "price_usd"
    ]
  },
  {
    "id": "metric:refund_rate",
    "name": "Refund Rate",
    "description": "Ratio of total refunds to total revenue.",
    "category": "cost",
    "grain": "global",
    "formula_natural": "Total refund_amount_usd divided by total order price_usd.",
    "formula_sql": "SELECT COALESCE(SUM(r.refund_amount_usd),0) / NULLIF(SUM(o.price_usd),0) AS refund_rate FROM orders o LEFT JOIN refunds r ON o.order_id = r.order_id;",
    "tables": [
      "orders",
      "refunds"
    ],
    "columns": [
      "price_usd",
      "refund_amount_usd"
    ]
  },
  {
    "id": "metric:session_to_order_conversion_rate",
    "name": "Session-to-Order Conversion Rate",
    "description": "Proportion of sessions that resulted in at least one order.",
    "category": "funnel",
    "grain": "global",
    "formula_natural": "Distinct session IDs present in orders divided by distinct session IDs in sessions.",
    "formula_sql": "SELECT CAST(COUNT(DISTINCT o.session_id) AS float) / NULLIF(COUNT(DISTINCT s.session_id),0) AS conversion_rate FROM sessions s LEFT JOIN orders o ON s.session_id = o.session_id;",
    "tables": [
      "sessions",
      "orders"
    ],
    "columns": [
      "session_id"
    ]
  },
  {
    "id": "metric:average_items_per_order",
    "name": "Average Items per Order",
    "description": "Mean number of items purchased per order.",
    "category": "operations",
    "grain": "global",
    "formula_natural": "Average of the items_purchased column from orders.",
    "formula_sql": "SELECT AVG(items_purchased) AS average_items_per_order FROM orders;",
    "tables": [
      "orders"
    ],
    "columns": [
      "items_purchased"
    ]
  }
]